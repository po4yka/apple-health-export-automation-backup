# =============================================================================
# Health Pipeline - Backup Sidecar
# =============================================================================
# Periodic backups of InfluxDB data and raw file archives.
# Based on influxdb:2.8 for the `influx backup` CLI.
#
# Build: docker compose build health-backup
# =============================================================================

FROM influxdb:2.8

LABEL org.opencontainers.image.title="health-backup"
LABEL org.opencontainers.image.description="Periodic InfluxDB and raw archive backups"
LABEL org.opencontainers.image.source="https://github.com/po4yka/apple-health-export-automation-backup"

RUN apt-get update && apt-get install -y --no-install-recommends \
    tar \
    gzip \
    findutils \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY scripts/backup.sh .
RUN chmod +x backup.sh

# Override influxdb entrypoint -- we only need the CLI, not the server
ENTRYPOINT []
CMD ["/bin/bash", "-c", "while true; do ./backup.sh; echo 'Sleeping for 24h...'; sleep 86400; done"]
